name: Analyze process by PID

on:
  workflow_dispatch:
    inputs:
      pid:
        description: "Process ID (PID) to analyze"
        required: true
        type: string

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Validate PID
        run: |
          PID="${{ inputs.pid }}"
          if ! [[ "$PID" =~ ^[0-9]+$ ]]; then
            echo "PID must be a number. Got: '$PID'"
            exit 1
          fi

      - name: Call proc API
        id: call_api
        env:
          API_TOKEN: ${{ secrets.PROC_API_TOKEN }}
          PID: ${{ inputs.pid }}
        run: |
          set +e

          URL="https://proc.mydomain.com/analysy"
          BODY=$(jq -n --arg pid "$PID" '{ pid: ($pid|tonumber) }')

          HTTP_RESPONSE=$(curl -sS -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${API_TOKEN}" \
            -d "$BODY" \
            -w "\n%{http_code}")

          HTTP_BODY="$(echo "$HTTP_RESPONSE" | head -n -1)"
          HTTP_CODE="$(echo "$HTTP_RESPONSE" | tail -n 1)"

          {
            echo "body<<EOF"
            echo "$HTTP_BODY"
            echo "EOF"
            echo "code=$HTTP_CODE"
          } >> "$GITHUB_OUTPUT"

      - name: Write report to Summary
        if: always()
        run: |
          echo "## ðŸ§ª Process Analysis Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**PID:** ${{ inputs.pid }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**HTTP Status:** ${{ steps.call_api.outputs.code }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### API Response" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo '${{ steps.call_api.outputs.body }}' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Fail job if API failed
        if: ${{ steps.call_api.outputs.code && !startsWith(steps.call_api.outputs.code, '2') }}
        run: |
          echo "API returned HTTP ${{ steps.call_api.outputs.code }}"
          exit 1

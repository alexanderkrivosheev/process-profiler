name: Dump -> Analyze -> AI Review

on:
  workflow_dispatch:
    inputs:
      pid:
        description: "Process ID (PID)"
        required: true
        type: string
      notes:
        description: "Notes (ticket, context, etc.)"
        required: false
        default: ""
        type: string
      base_url:
        description: "DumpAgent base URL"
        required: true
        default: "http://YOUR-SERVER-IP:5057"
        type: string

jobs:
  dump_analyze_ai:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Step 1 â€” Create Dump
        id: dump
        run: |
          echo "Calling /dump..."
          RESPONSE=$(curl -s -X POST "${{ inputs.base_url }}/dump" \
            -H "Content-Type: application/json" \
            -d "{\"pid\":${{ inputs.pid }}}")

          echo "$RESPONSE" | jq .

          if [[ $(echo "$RESPONSE" | jq -r '.ok') != "true" ]]; then
            echo "âŒ Dump step failed"
            exit 1
          fi

          DUMP_PATH=$(echo "$RESPONSE" | jq -r '.dumpPath')
          echo "dumpPath=$DUMP_PATH" >> $GITHUB_OUTPUT

      - name: Step 2 â€” Analyze Dump
        id: analyze
        run: |
          echo "Calling /analyze..."
          RESPONSE=$(curl -s -X POST "${{ inputs.base_url }}/analyze" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg path "${{ steps.dump.outputs.dumpPath }}" \
              --arg notes "${{ inputs.notes }}" \
              '{dumpPath:$path, notes:$notes}')")

          echo "$RESPONSE" | jq .

          if [[ $(echo "$RESPONSE" | jq -r '.ok') != "true" ]]; then
            echo "âŒ Analyze step failed"
            exit 1
          fi

          REPORT_PATH=$(echo "$RESPONSE" | jq -r '.reportPath')
          EXIT_CODE=$(echo "$RESPONSE" | jq -r '.exitCode')

          echo "reportPath=$REPORT_PATH" >> $GITHUB_OUTPUT

          if [[ "$EXIT_CODE" != "0" ]]; then
            echo "âŒ Analyze returned exitCode=$EXIT_CODE"
            exit 1
          fi

      - name: Step 3 â€” AI Review
        id: ai
        run: |
          echo "Calling /ai-review..."
          RESPONSE=$(curl -s -X POST "${{ inputs.base_url }}/ai-review" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg path "${{ steps.analyze.outputs.reportPath }}" \
              --arg notes "${{ inputs.notes }}" \
              '{reportPath:$path, notes:$notes}')")

          echo "$RESPONSE" | jq .

          if [[ $(echo "$RESPONSE" | jq -r '.ok') != "true" ]]; then
            echo "âŒ AI step failed"
            exit 1
          fi

          AI_TEXT=$(echo "$RESPONSE" | jq -r '.aiText')
          AI_REPORT_PATH=$(echo "$RESPONSE" | jq -r '.aiReportPath')

          mkdir -p out
          echo "$AI_TEXT" > out/ai_summary.txt

          echo "aiReportPath=$AI_REPORT_PATH" >> $GITHUB_OUTPUT

      - name: ðŸ§  Write Summary
        run: |
          echo "## ðŸ§ª Dump Analysis Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PID:** ${{ inputs.pid }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dump:** \`${{ steps.dump.outputs.dumpPath }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Report:** \`${{ steps.analyze.outputs.reportPath }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**AI Report:** \`${{ steps.ai.outputs.aiReportPath }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§  AI Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat out/ai_summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¦ Upload AI Summary
        uses: actions/upload-artifact@v4
        with:
          name: dump-ai-summary
          path: out/ai_summary.txt
